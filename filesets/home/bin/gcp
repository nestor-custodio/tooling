#! /bin/env bash
source '/home/nestor/bin/std.lib'

# ---

{ # -- Help Text -- #

	cat <<-EOF | store-as usage
		Usage: $( script-name ) { vms | list-vms } [--all] [-- OPTIONS]
		       $( name-blanks ) vm INSTANCE_NAME
		       $( name-blanks ) state INSTANCE_NAME

		       $( script-name ) { scp | cp } [-- OPTIONS] SOURCE TARGET

		       $( script-name ) { ssh | shell | connect } [USER@]INSTANCE_NAME
		       $( script-name ) { run | exec | do } [USER@]INSTANCE_NAME REMOTE_COMMAND


		       $( script-name ) { up
		       $( name-blanks )   | suspend | sleep
		       $( name-blanks )   | restart | reboot
		       $( name-blanks )   | stop | shutdown | kill } INSTANCE_NAME


		       $( script-name ) rename INSTANCE_NAME NEW_INSTANCE_NAME

		       $( script-name ) scale INSTANCE_NAME { --machine-type MACHINE_TYPE | --micro
		       $( name-blanks )                                                   | --small
		       $( name-blanks )                                                   | --medium
		       $( name-blanks )                                                   | --standard }

		       $( script-name ) { destroy | delete | trash } INSTANCE_NAME


		Convenience wrapper for various Google Cloud Platform client commands.
		Acts as an alias for 'glcoud compute' when not used as above.


		Mandatory arguments to long options are mandatory for short options too.
		  --help                    Show this help text.

		  --machine-type            Compute Instance machine type.
		    --micro                 Shortcut for "--machine-type=e2-micro".
		    --small                 Shortcut for "--machine-type=e2-small".
		    --medium                Shortcut for "--machine-type=e2-medium".
		    --standard              Shortcut for "--machine-type=e2-standard-2".


		Machine Types
		  See https://cloud.google.com/compute/vm-instance-pricing for a list of types.


		Exit Status:
		  0  if OK,
		  1  if invalid option,
		  2  if invalid request,
		  3  if other internal error.
	EOF

}

# ---

{ # -- Utility Functions -- #

	function is-localhost {
		local instance_name="$1" && shift
		[ -n "$instance_name" ] || error-out 3 'no instance name given'

		[ "$instance_name" == "$( vm-name )" ]
	}

	function instance-state {
		local instance_name="$1" && shift
		[ -n "$instance_name" ] || error-out 3 'no instance name given'

		gcloud compute instances list --filter="(name:'${instance_name}')" --format='value(status)'
	}

	# ---

	function instance-is-running { [ "$( instance-state "$@" )" == 'RUNNING'    ] ;}
	function instance-is-stopped { [ "$( instance-state "$@" )" == 'TERMINATED' ] ;}

}

# ---

{ # -- Parameter Processing: Options -- #

	# Set defaults.

	all=''
	machine_type=''

	[ -n "$CLOUDSDK_COMPUTE_ZONE" ] || export CLOUDSDK_COMPUTE_ZONE="$( vm-zone )"

	# --
	# --

	CHAR_OPTS=''
	LONG_OPTS='help,all,machine-type:,micro,small,medium,standard'

	set-params
	while true; do
		option="$1" && shift
		case "$option" in
			(--help) exit-out "$usage" ;;
			(--) break ;;  # No more options.


			(--all)
				all='1'
				;;

			(--machine-type)
				machine_type="$1" && shift
				;;

			(--micro)
				machine_type='e2-micro'
				;;

			(--small)
				machine_type='e2-small'
				;;

			(--medium)
				machine_type='e2-medium'
				;;

			(--standard)
				machine_type='e2-standard-2'
				;;

		esac
	done

}

{ # -- Parameter Processing: Positionals -- #

	[ "$#" != 0 ] || error-out 1 'no command given'


	command="$1" && shift
	case "$command" in

		(vms|list-vms)
			if [ -n "$all" ]; then
				gcloud compute instances list --sort-by='status,name' "$@"
			else
				gcloud compute instances list --sort-by='status,name' --filter="(status:'RUNNING')" "$@"
			fi
			;;

		(vm)
			[ "$#" == 1 ] || error-out 1 'no instance name given'
			instance_name="$1" && shift

			gcloud compute instances list --filter="(name:'${instance_name}')" "$@"
			;;

		(state|status)
			[ "$#" == 1 ] || error-out 1 'no instance name given'
			instance_name="$1" && shift

			instance-state "$instance_name"
			;;

		# ---
		# ---

		(scp|cp)
			gcloud compute scp "$@"
			;;

		# ---
		# ---

		(ssh|shell|connect)
			[ "$#" == 1 ] || error-out 1 'no instance name given'
			instance_name="$1" && shift

			# Run sanity checks.

				# Check for current-instance request.
				#
				is-localhost "$instance_name" && error-out 2 'cannot remote into localhost'


			gcloud compute ssh "$instance_name"
			;;

		(run|exec|do)
			[ "$#" -lt 2 ] && error-out 1 'an instance name and remote command are required'
			[ "$#" -gt 2 ] && error-out 1 'too many parameters'

			instance_name="$1" && shift
			remote_command="$1" && shift


			gcloud compute ssh "$instance_name" --command="$remote_command"
			;;

		# ---
		# ---

		(up)
			[ "$#" == 1 ] || error-out 1 'no instance name given'
			instance_name="$1" && shift


			instance-state "$instance_name" | store-as state
			case "$state" in

				(RUNNING)
					exit-out 0
					;;

				(TERMINATED)
					echo -n 'Starting instance...'
					gcloud compute instances start "$instance_name" &> /dev/null || error-out 3 'FAILED'
					echo ' done.'
					;;

				(SUSPENDED)
					echo -n 'Resuming instance...'
					gcloud compute instances resume "$instance_name" &> /dev/null || error-out 3 'FAILED'
					echo ' done.'

					echo -n 'Updating DNS entry...'
					sleep 2  # Instances will sometimes take a bit to fully wake and request a new external IP.
					expose-vm "$instance_name" || error-out 3 'FAILED'
					echo ' done.'
					;;

				*)
					error-out 2 "unable to start/wake a '${state}' VM"
					;;

			esac

			# Wait for the VM to become "connectable".
			#
			echo -n 'Waiting for instance to respond...'
			vm-lan-ip "$instance_name" | store-as vm_lan_ip
			[ -n "$vm_lan_ip" ] || error-out 3 'FAILED'
			while true; do timeout 0.2 nc "$vm_lan_ip" 22 2> /dev/null | 'has?' SSH && break; sleep 1s; done
			echo ' done.'
			;;

		(suspend|sleep)
			[ "$#" == 1 ] || error-out 1 'no instance name given'
			instance_name="$1" && shift


			echo -n 'Suspending instance...'
			gcloud compute instances suspend "$instance_name" &> /dev/null || error-out 3 'FAILED'
			echo ' done.'
			;;

		(restart|reboot)
			[ "$#" == 1 ] || error-out 1 'no instance name given'
			instance_name="$1" && shift


			echo -n 'Restarting instance...'
			gcloud compute instances reset "$instance_name" &> /dev/null || error-out 3 'FAILED'
			echo ' done.'

			echo -n 'Waiting for instance to respond...'
			vm-lan-ip "$instance_name" | store-as vm_lan_ip
			[ -n "$vm_lan_ip" ] || error-out 3 'FAILED'
			while true; do timeout 0.2 nc "$vm_lan_ip" 22 2> /dev/null | 'has?' SSH && break; sleep 1s; done
			echo ' done.'
			;;

		(stop|shutdown|kill)
			[ "$#" == 1 ] || error-out 1 'no instance name given'
			instance_name="$1" && shift


			echo -n 'Stopping instance...'
			gcloud compute instances stop "$instance_name" &> /dev/null || error-out 3 'FAILED'
			echo ' done.'
			;;

		# ---
		# ---

		(rename)
			[ "$#" -lt 2 ] && error-out 1 'old and new instance names are required'
			[ "$#" -gt 2 ] && error-out 1 'too many parameters'

			old_instance_name="$1" && shift
			new_instance_name="$1" && shift


			# Run sanity checks.

				# Check that instance in question is currently *stopped*.
				#
				instance-is-stopped "$old_instance_name" || error-out 2 'cannot rename a running instance'


			echo -n 'Renaming instance...'
			gcloud compute instances set-name "$old_instance_name" --new-name="$new_instance_name" &> /dev/null || error-out 3 'FAILED'
			echo ' done.'

			echo -n 'Removing DNS entry...'
			dns del --for="$old_instance_name" &> /dev/null || error-out 3 'FAILED'
			echo ' done.'
			;;

		(scale)
			[ "$#" == 1 ] || error-out 1 'no instance name given'
			instance_name="$1" && shift

			[ -n "$machine_type" ] || error-out 1 'no machine type given'


			# Run sanity checks.

				# Verify given machine type exists in the active zone.
				#
				gcloud compute machine-types list --zones="$( vm-zone )" \
				                                  --format='value(name)' \
				| 'has-line?' "$machine_type" &> /dev/null || error-out 1 'invalid machine type'

				# This is a noop if the requested machine type is already set.
				#
				[ "$machine_type" == "$( instance machine-type --short )" ] && exit 0

				# Check that instance in question is currently *stopped*.
				#
				instance-is-stopped "$instance_name" || error-out 2 'cannot set scaling on a running instance'


			echo -n 'Scaling instance...'
			gcloud compute instances set-machine-type "$instance_name" --machine-type="$machine_type" || error-out 3 'FAILED'
			echo ' done.'
			;;

		# ---

		(destroy|delete|trash)
			[ "$#" == 1 ] || error-out 1 'no instance name given'
			instance_name="$1" && shift


			# Note the actual VM deletion is triggered *last* to allow for destroy requests from within the target instance.
			# (Otherwise the VM deletion would occur before script completion, leaving some work undone.)


			# Remove DNS 'A' record.
			#
			echo -n 'Removing DNS entry...'
			dns delete --for="$instance_name" &> /dev/null
			echo ' done.'

			# Delete the Instance VM.
			#
			echo -n 'Tearing down  instance...'
			yes | gcloud compute instances delete "$instance_name" &> /dev/null || error-out 3 'FAILED'
			echo ' done.'
			;;

		# ---
		# ---

		*)
			gcloud compute "$command" "$@"
			;;

	esac

}

# ---
# ---


noop  # Positional parameter processing has already taken care of everything.
